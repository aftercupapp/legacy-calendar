<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aftercup</title>

    <style>
        html { height: 100%; }

        body {
            margin: 0; padding: 0; width: 100%; min-height: 100%;
            font-family: sans-serif; font-size: 14px;
            overflow-y: auto;
            position: relative;
        }

        * { box-sizing: border-box; }

        body.theme-light { background: #fff; color: #000; }
        body.theme-light .app-header { background: #f0f0f0; border-bottom: 2px solid #000; }
        body.theme-light .header-center { color: #000; }
        body.theme-light .event-item { border-bottom: 1px solid #ccc; }
        body.theme-light .event-title { color: #000; }
        body.theme-light .event-date { color: #666; }
        body.theme-light .popup { background: #fff; color: #000; }
        body.theme-light input, body.theme-light textarea, body.theme-light select { background: #fff; color: #000; border: 1px solid #000; }

        body.theme-dark { background: #000; color: #fff; }
        body.theme-dark .app-header { background: #222; border-bottom: 2px solid #666; }
        body.theme-dark .header-center { color: #fff; }
        body.theme-dark .event-item { border-bottom: 1px solid #333; }
        body.theme-dark .event-title { color: #fff; }
        body.theme-dark .event-date { color: #aaa; }
        body.theme-dark .popup { background: #111; color: #fff; }
        body.theme-dark input, body.theme-dark textarea, body.theme-dark select { background: #333; color: #fff; border: 1px solid #666; }
        body.theme-dark .btn { background: #333; color: #fff; border: 1px solid #666; }
        body.theme-dark .action-btn { background: #333; color: #fff; border: 1px solid #666; }
        body.theme-dark #month-controls { background: #222; color: #fff; border-bottom: 1px solid #333; }
        body.theme-dark td { border: 1px solid #333; }
        body.theme-dark #day-preview { background: #111; border-top: 2px solid #666; }

        body.theme-blue { background: #e6f2ff; color: #003366; }
        body.theme-blue .app-header { background: #0066cc; border-bottom: 2px solid #003366; }
        body.theme-blue .header-center { color: #fff; }
        body.theme-blue .event-item { border-bottom: 1px solid #99ccff; }
        body.theme-blue .event-title { color: #003366; }
        body.theme-blue .event-date { color: #0066cc; }
        body.theme-blue .popup { background: #e6f2ff; color: #003366; }
        body.theme-blue input, body.theme-blue textarea, body.theme-blue select { background: #fff; color: #003366; border: 1px solid #0066cc; }
        body.theme-blue .btn { background: #cce6ff; color: #003366; border: 1px solid #004080; }
        body.theme-blue .btn-black { background: #003366; color: #fff; border: 1px solid #000; }
        body.theme-blue .action-btn { background: #cce6ff; color: #003366; border: 1px solid #004080; }
        body.theme-blue .btn-del { background: #003366; color: #fff; border: 1px solid #000; }
        body.theme-blue .full-btn { background: #005ce6; color: #fff; border: 1px solid #003366; }
        body.theme-blue .secondary-btn { background: #fff; color: #005ce6; border: 1px solid #005ce6; }
        body.theme-blue #month-controls { background: #cce6ff; color: #003366; border-bottom: 1px solid #99ccff; }
        body.theme-blue th { background: #004080; color: #fff; }
        body.theme-blue td { border: 1px solid #99ccff; background: #fff; }
        body.theme-blue .has-event { background: #b3d9ff; color: #003366; font-weight: bold; }
        body.theme-blue .selected-day { background: #005ce6 !important; color: #fff !important; }
        body.theme-blue .today-cell { border: 2px solid #003366; }
        body.theme-blue #day-preview { background: #d9e6f2; border-top: 2px solid #004080; }

        body.theme-pink { background: #fff0f5; color: #880e4f; }
        body.theme-pink .app-header { background: #e91e63; border-bottom: 2px solid #880e4f; }
        body.theme-pink .header-center { color: #fff; }
        body.theme-pink .event-item { border-bottom: 1px solid #f8bbd0; }
        body.theme-pink .event-title { color: #880e4f; }
        body.theme-pink .event-date { color: #d81b60; }
        body.theme-pink .popup { background: #fff0f5; color: #880e4f; }
        body.theme-pink input, body.theme-pink textarea, body.theme-pink select { background: #fff; color: #880e4f; border: 1px solid #e91e63; }
        body.theme-pink .btn { background: #f8bbd0; color: #880e4f; border: 1px solid #c2185b; }
        body.theme-pink .btn-black { background: #880e4f; color: #fff; border: 1px solid #000; }
        body.theme-pink .action-btn { background: #f8bbd0; color: #880e4f; border: 1px solid #c2185b; }
        body.theme-pink .btn-del { background: #880e4f; color: #fff; border: 1px solid #000; }
        body.theme-pink .full-btn { background: #d81b60; color: #fff; border: 1px solid #880e4f; }
        body.theme-pink .secondary-btn { background: #fff; color: #d81b60; border: 1px solid #d81b60; }
        body.theme-pink #month-controls { background: #f8bbd0; color: #880e4f; border-bottom: 1px solid #f48fb1; }
        body.theme-pink th { background: #c2185b; color: #fff; }
        body.theme-pink td { border: 1px solid #f48fb1; background: #fff; }
        body.theme-pink .has-event { background: #fce4ec; color: #880e4f; font-weight: bold; }
        body.theme-pink .selected-day { background: #d81b60 !important; color: #fff !important; }
        body.theme-pink .today-cell { border: 2px solid #880e4f; }
        body.theme-pink #day-preview { background: #fce4ec; border-top: 2px solid #c2185b; }

        .app-header { height: 50px; width: 100%; position: absolute; top: 0; left: 0; z-index: 10; }
        .header-center { position: absolute; top: 0; left: 0; width: 100%; height: 50px; line-height: 50px; text-align: center; font-weight: bold; font-size: 18px; text-transform: uppercase; z-index: 1; }
        .header-left { position: absolute; top: 8px; left: 5px; z-index: 10; }
        .header-right { position: absolute; top: 8px; right: 5px; z-index: 10; }

        .btn { background: #ddd; border: 1px solid #000; font-weight: bold; color: #000; cursor: pointer; font-size: 18px; width: 36px; height: 34px; padding: 0; text-align: center; line-height: 32px; }
        .btn-black { background: #000; color: #fff; border: 1px solid #000; }

        .view-container { padding-top: 50px; padding-bottom: 50px; width: 100%; display: block; }

        #event-list-content, #preview-list { padding-bottom: 80px; }

        .event-item { padding: 12px 8px 12px 12px; min-height: 50px; position: relative; border-left: 5px solid transparent; }
        .event-date { font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        .event-title { font-size: 16px; font-weight: bold; padding-right: 80px; display: block; }

        .item-actions { position: absolute; top: 10px; right: 5px; }
        .action-btn { font-size: 12px; font-weight:bold; width: 30px; height: 30px; border: 1px solid #999; background: #eee; margin-left: 5px; cursor: pointer; padding: 0; }
        .btn-del { background: #000; color: #fff; border-color: #000; }

        #month-controls { text-align: center; padding: 8px; background: #eee; border-bottom: 1px solid #ccc; font-weight: bold; }
        table.calendar-grid { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { font-size: 11px; background: #333; color: #fff; padding: 4px 0; }
        td { height: 32px; border: 1px solid #ccc; text-align: center; font-size: 13px; cursor: pointer; }

        .has-event { background-color: #ddd; font-weight: bold; text-decoration: underline; color: #000; }
        .selected-day { background-color: #000 !important; color: #fff !important; }
        .today-cell { border: 2px solid #000; }
        #day-preview { border-top: 2px solid #000; padding: 5px; background: #f9f9f9; min-height: 100px; }

        .popup { display: none; position: absolute; top: 0; left: 0; width: 100%; min-height: 100%; z-index: 100; padding: 10px; }
        .popup h3 { margin: 5px 0 10px 0; border-bottom: 2px solid #000; font-size: 18px; }

        label { display: block; margin-bottom: 3px; font-weight: bold; font-size: 14px; }
        input, textarea, select { width: 95%; padding: 8px; margin-bottom: 12px; border: 1px solid #000; font-family: sans-serif; font-size: 16px; }

        .full-btn { width: 95%; padding: 12px; border: 1px solid #000; background: #000; color: #fff; margin-bottom: 8px; font-size: 16px; font-weight: bold; }
        .secondary-btn { background: #fff; color: #000; }

        .theme-row { text-align: center; margin-bottom: 15px; }
        .theme-btn { width: 22%; padding: 8px; font-size: 11px; margin: 0 1%; cursor: pointer; border: 1px solid #000; }

        .color-row { margin-bottom: 15px; }
        .color-opt { display: inline-block; width: 30px; height: 30px; margin-right: 10px; border: 2px solid #ccc; cursor: pointer; }
        .color-opt.selected { border: 2px solid #000; box-shadow: 0 0 3px #000; }
    </style>
</head>
<body onload="initApp()" class="theme-light">

<div class="app-header">
    <div class="header-center">Calendar</div>
    <div class="header-left">
        <button id="btn-toggle" class="btn" onclick="toggleView()">#</button>
    </div>
    <div class="header-right">
        <button class="btn" onclick="openMenu()">*</button>
        <button class="btn btn-black" onclick="openAddPopup()">+</button>
    </div>
</div>

<div id="view-list" class="view-container">
    <div id="event-list-content"></div>
</div>

<div id="view-month" class="view-container" style="display:none;">
    <div id="month-controls">
        <button class="btn" style="width:30px; height:30px; line-height:28px;" onclick="changeMonth(-1)">&lt;</button>
        <span id="month-label" style="margin:0 10px; font-size:16px;">Jan 2026</span>
        <button class="btn" style="width:30px; height:30px; line-height:28px;" onclick="changeMonth(1)">&gt;</button>
    </div>
    <table class="calendar-grid">
        <thead id="cal-head"><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr></thead>
        <tbody id="calendar-body"></tbody>
    </table>
    <div id="day-preview">
        <div style="font-size:14px; font-weight:bold; margin-bottom:5px;" id="preview-date-label">Events</div>
        <div id="preview-list"></div>
    </div>
</div>

<div id="menu-popup" class="popup">
    <h3>Menu</h3>
    <button class="full-btn" onclick="openSearch()">Search Events</button>
    <button class="full-btn" onclick="openJump()">Jump to Date</button>
    <button class="full-btn" onclick="goToToday()">Go to Today</button>
    <button class="full-btn" onclick="openSettings()">Settings & Theme</button>
    <button class="full-btn secondary-btn" onclick="closePopups()">Close</button>
</div>

<div id="search-popup" class="popup">
    <h3>Search</h3>
    <input type="text" id="search-input" placeholder="Type title..." onkeyup="runSearch()" />
    <div id="search-results"></div>
    <button class="full-btn secondary-btn" onclick="closePopups()">Close</button>
</div>

<div id="jump-popup" class="popup">
    <h3>Jump to Date</h3>
    <label>Year:</label>
    <select id="jump-year"></select>
    <label>Month:</label>
    <select id="jump-month">
        <option value="0">January</option><option value="1">February</option>
        <option value="2">March</option><option value="3">April</option>
        <option value="4">May</option><option value="5">June</option>
        <option value="6">July</option><option value="7">August</option>
        <option value="8">September</option><option value="9">October</option>
        <option value="10">November</option><option value="11">December</option>
    </select>
    <button class="full-btn" onclick="executeJump()">GO</button>
    <button class="full-btn secondary-btn" onclick="closePopups()">Cancel</button>
</div>

<div id="event-popup" class="popup">
    <h3 id="popup-title">New Event</h3>
    <label>Date (YYYY-MM-DD):</label> <input type="text" id="input-date" />
    <label>Title:</label> <input type="text" id="input-title" />
    <label>Category Color:</label>
    <div class="color-row">
        <div class="color-opt" style="background:#cc0000;" onclick="selectColor('#cc0000', this)"></div>
        <div class="color-opt" style="background:#009900;" onclick="selectColor('#009900', this)"></div>
        <div class="color-opt" style="background:#0033cc;" onclick="selectColor('#0033cc', this)"></div>
        <div class="color-opt" style="background:#ffcc00;" onclick="selectColor('#ffcc00', this)"></div>
    </div>
    <input type="hidden" id="input-color" value="#0033cc" />
    <button class="full-btn" onclick="saveEvent()">SAVE</button>
    <button class="full-btn secondary-btn" onclick="closePopups()">CANCEL</button>
</div>

<div id="settings-popup" class="popup">
    <h3>Settings</h3>
    <label>Theme:</label>
    <div class="theme-row">
        <button class="theme-btn" style="background:#fff; color:#000;" onclick="setTheme('light')">Light</button>
        <button class="theme-btn" style="background:#000; color:#fff;" onclick="setTheme('dark')">Dark</button>
        <button class="theme-btn" style="background:#0066cc; color:#fff;" onclick="setTheme('blue')">Blue</button>
        <button class="theme-btn" style="background:#e91e63; color:#fff;" onclick="setTheme('pink')">Pink</button>
    </div>
    <label>Calendar View:</label>
    <button class="full-btn" id="btn-weekstart" onclick="toggleWeekStart()" style="margin-bottom:15px;">Start: Mon</button>

    <label>Data Management:</label>
    <button class="full-btn" onclick="resetToDefault()">Reset to Default Data</button>

    <label>Backup Data:</label> <textarea id="backup-area" readonly style="height:50px"></textarea>
    <label>Restore Data:</label> <textarea id="restore-area" style="height:50px"></textarea>
    <button class="full-btn" onclick="restoreData()">RESTORE</button>
    <button class="full-btn secondary-btn" onclick="closePopups()">Back</button>
</div>

<script>
    var eventsData = []; var editingId = null; var currentView = 'list';
    var calDate = new Date(); var selectedDateStr = "";
    var weekStartDay = 1;
    var scrollPos = 0;

    function initApp() {
        var savedTheme = localStorage.getItem('app_theme') || 'light';
        setTheme(savedTheme);
        var ws = localStorage.getItem('week_start');
        weekStartDay = (ws === null) ? 1 : parseInt(ws);
        updateWeekStartBtn();

        selectedDateStr = formatDateStr(new Date());
        populateJumpYears();
        loadData();
    }

    // Called from Java when hardware back button is pressed
    function handleBackButton() {
        var popups = document.getElementsByClassName("popup");
        for(var i=0; i<popups.length; i++) {
            if(popups[i].style.display === "block") {
                closePopups();
                return;
            }
        }
        if(currentView === 'month') {
            toggleView();
            return;
        }
        if(window.Android) {
            window.Android.closeApp();
        }
    }

    function populateJumpYears() {
        var sel = document.getElementById("jump-year");
        var y = new Date().getFullYear();
        for(var i=y-5; i<=y+5; i++) {
            var opt = document.createElement("option");
            opt.value = i; opt.text = i;
            if(i === y) opt.selected = true;
            sel.appendChild(opt);
        }
    }

    function setTheme(t) {
        document.body.className = "theme-" + t;
        localStorage.setItem('app_theme', t);
    }

    function toggleWeekStart() {
        weekStartDay = (weekStartDay === 1) ? 0 : 1;
        localStorage.setItem('week_start', weekStartDay);
        updateWeekStartBtn();
        if(currentView === 'month') renderCalendar();
    }

    function updateWeekStartBtn() {
        var lbl = (weekStartDay === 1) ? "Start: Mon" : "Start: Sun";
        document.getElementById("btn-weekstart").innerHTML = lbl;
    }

    function loadData() {
        if(window.localStorage && localStorage.getItem('local_list')) {
            try { eventsData = JSON.parse(localStorage.getItem('local_list')); renderCurrentView(); } catch(e) { eventsData = []; }
        } else {
            var xhr = new XMLHttpRequest(); xhr.overrideMimeType("application/json");
            xhr.open("GET", "data.json", true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && (xhr.status === 200 || xhr.status === 0)) {
                    try {
                        eventsData = JSON.parse(xhr.responseText);
                        for(var i=0; i<eventsData.length; i++) {
                            if(!eventsData[i].id) eventsData[i].id = new Date().getTime()+i;
                            if(!eventsData[i].color) eventsData[i].color = "transparent";
                        }
                        renderCurrentView();
                    } catch (e) {}
                }
            }; xhr.send(null);
        }
    }
    function saveData() { if(window.localStorage) localStorage.setItem('local_list', JSON.stringify(eventsData)); renderCurrentView(); }

    function resetToDefault() {
        if(confirm("Erase all data and reload data.json?")) {
            localStorage.removeItem('local_list');
            eventsData = [];
            loadData();
            closePopups();
        }
    }

    function toggleView() {
        var btn = document.getElementById('btn-toggle');
        if(currentView === 'list') {
            currentView = 'month';
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-month').style.display = 'block';
            btn.innerHTML = '='; renderCalendar(); renderPreviewList();
        } else {
            currentView = 'list';
            document.getElementById('view-list').style.display = 'block';
            document.getElementById('view-month').style.display = 'none';
            btn.innerHTML = '#'; renderList();
        }
    }
    function renderCurrentView() { if(currentView === 'list') renderList(); else { renderCalendar(); renderPreviewList(); } }

    function renderList() {
        var c = document.getElementById("event-list-content"); c.innerHTML = "";
        if (eventsData.length === 0) { c.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.5;">No events.</div>'; return; }

        // CHANGED: Sort Descending (Newest First)
        eventsData.sort(function(a, b) { return b.date.localeCompare(a.date); });

        var html = '';
        for (var i = 0; i < eventsData.length; i++) {
            var item = eventsData[i];
            var col = item.color || "transparent";
            html += '<div class="event-item" style="border-left-color:' + col + '"><div class="event-date">' + item.date + '</div>';
            html += '<div class="event-title">' + item.title + '</div>';
            html += '<div class="item-actions">';
            html += '<button class="action-btn" onclick="openEdit(' + item.id + ')">/</button>';
            html += '<button class="action-btn btn-del" onclick="deleteEvent(' + item.id + ')">X</button>';
            html += '</div></div>';
        }
        c.innerHTML = html;
    }

    function changeMonth(d) { calDate.setMonth(calDate.getMonth() + d); renderCalendar(); }
    function renderCalendar() {
        var year = calDate.getFullYear(); var month = calDate.getMonth();
        var mNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        document.getElementById("month-label").innerHTML = mNames[month] + " " + year;

        var headHtml = "<tr>";
        var daysMin = (weekStartDay === 1) ? ["M","T","W","T","F","S","S"] : ["S","M","T","W","T","F","S"];
        for(var h=0; h<7; h++) headHtml += "<th>" + daysMin[h] + "</th>";
        headHtml += "</tr>";
        document.getElementById("cal-head").innerHTML = headHtml;

        var firstDay = new Date(year, month, 1).getDay();
        var startOffset = (firstDay - weekStartDay + 7) % 7;
        var daysInMonth = new Date(year, month+1, 0).getDate();

        var today = formatDateStr(new Date());
        var html = ''; var d = 1;
        for (var i=0; i<6; i++) {
            html += '<tr>';
            for (var j=0; j<7; j++) {
                if ((i===0 && j<startOffset) || d>daysInMonth) { html += '<td></td>'; } else {
                    var cStr = year + "-" + pad(month+1) + "-" + pad(d);
                    var has = false; for(var k=0; k<eventsData.length; k++) if(eventsData[k].date===cStr) { has=true; break; }
                    var cls = []; if(has) cls.push("has-event"); if(cStr===today) cls.push("today-cell"); if(cStr===selectedDateStr) cls.push("selected-day");
                    html += '<td class="' + cls.join(" ") + '" onclick="selectDate(\'' + cStr + '\')">' + d + '</td>'; d++;
                }
            }
            html += '</tr>'; if (d>daysInMonth) break;
        }
        document.getElementById("calendar-body").innerHTML = html;
    }

    function selectDate(s) { selectedDateStr = s; renderCalendar(); renderPreviewList(); }
    function renderPreviewList() {
        var c = document.getElementById("preview-list");
        document.getElementById("preview-date-label").innerHTML = selectedDateStr;
        var html = ''; var count = 0;
        for(var i=0; i<eventsData.length; i++) {
            if(eventsData[i].date === selectedDateStr) {
                var col = eventsData[i].color || "transparent";
                html += '<div style="padding:12px 5px; border-bottom:1px solid #666; position:relative; min-height:50px; border-left:5px solid ' + col + '; padding-left:8px;">';
                html += '<span style="font-weight:bold; display:block; padding-right:45px;">' + eventsData[i].title + '</span>';
                html += '<button class="action-btn btn-del" style="position:absolute; top:10px; right:5px;" onclick="deleteEvent(' + eventsData[i].id + ')">X</button>';
                html += '</div>';
                count++;
            }
        }
        if(count === 0) html = '<div style="opacity:0.5; padding:5px; font-style:italic;">Empty.</div>';
        html += '<div style="margin-top:10px; text-align:center;"><button class="full-btn" style="width:95%" onclick="openAddPopup(\'' + selectedDateStr + '\')">+</button></div>';
        c.innerHTML = html;
    }

    function deleteEvent(id) { if(confirm("Delete?")) { var n=[]; for(var i=0;i<eventsData.length;i++) if(eventsData[i].id!=id) n.push(eventsData[i]); eventsData=n; saveData(); } }

    function openEdit(id) {
        var item; for(var i=0;i<eventsData.length;i++) if(eventsData[i].id==id) item=eventsData[i];
        if(item) {
            editingId=id; document.getElementById("popup-title").innerHTML="Edit";
            document.getElementById("input-title").value=item.title;
            document.getElementById("input-date").value=item.date;
            document.getElementById("input-color").value=item.color || "#0033cc";
            showPopup("event-popup");
        }
    }

    function saveEvent() {
        var t=document.getElementById("input-title").value; var d=document.getElementById("input-date").value;
        var c=document.getElementById("input-color").value;
        if(!t||!d) { alert("Data missing"); return; }
        if(editingId) { for(var i=0;i<eventsData.length;i++) if(eventsData[i].id==editingId) { eventsData[i].title=t; eventsData[i].date=d; eventsData[i].color=c; break; } }
        else { eventsData.push({ id:new Date().getTime(), title:t, date:d, color:c }); }
        saveData(); closePopups();
    }

    function selectColor(c, el) {
        document.getElementById("input-color").value = c;
        var opts = document.getElementsByClassName("color-opt");
        for(var i=0; i<opts.length; i++) opts[i].className = "color-opt";
        el.className = "color-opt selected";
    }

    function showPopup(id) {
        scrollPos = window.scrollY;
        document.getElementById("view-list").style.display = "none";
        document.getElementById("view-month").style.display = "none";
        document.getElementById(id).style.display = "block";
        window.scrollTo(0, 0);
    }

    function openMenu() { showPopup("menu-popup"); }
    function openSearch() { showPopup("search-popup"); document.getElementById("search-input").value=""; document.getElementById("search-results").innerHTML=""; }
    function openJump() { showPopup("jump-popup"); }
    function openSettings() { showPopup("settings-popup"); document.getElementById("backup-area").value=JSON.stringify(eventsData); }
    function openAddPopup(d) {
        editingId=null; document.getElementById("popup-title").innerHTML="New";
        document.getElementById("input-title").value="";
        document.getElementById("input-date").value=d||selectedDateStr||formatDateStr(new Date());
        showPopup("event-popup");
    }

    function closePopups() {
        var popups = document.getElementsByClassName("popup");
        for(var i=0; i<popups.length; i++) popups[i].style.display="none";
        editingId=null;

        if(currentView === 'list') {
            document.getElementById("view-list").style.display = "block";
        } else {
            document.getElementById("view-month").style.display = "block";
        }
        window.scrollTo(0, scrollPos);
    }

    function runSearch() {
        var term = document.getElementById("search-input").value.toLowerCase();
        var res = document.getElementById("search-results");
        res.innerHTML = "";
        if(term.length < 1) return;
        var html = "";
        for(var i=0; i<eventsData.length; i++) {
            if(eventsData[i].title.toLowerCase().indexOf(term) > -1) {
                html += '<div style="padding:10px; border-bottom:1px solid #ccc;" onclick="jumpToSearchResult(\'' + eventsData[i].date + '\')">';
                html += '<b>' + eventsData[i].date + '</b><br/>' + eventsData[i].title + '</div>';
            }
        }
        res.innerHTML = html || "<div style='padding:10px;'>No results</div>";
    }

    function jumpToSearchResult(d) {
        selectedDateStr = d;
        calDate = new Date(d);
        closePopups();
        if(currentView === 'list') {
             alert("Found! Switch to Month view to see context.");
        } else {
             renderCalendar(); renderPreviewList();
        }
    }

    function executeJump() {
        var y = document.getElementById("jump-year").value;
        var m = document.getElementById("jump-month").value;
        calDate.setFullYear(y); calDate.setMonth(m); calDate.setDate(1);
        if(currentView === 'list') toggleView();
        else renderCalendar();
        closePopups();
    }

    function goToToday() {
        var now = new Date();
        calDate = now;
        selectedDateStr = formatDateStr(now);
        if(currentView === 'list') toggleView();
        else { renderCalendar(); renderPreviewList(); }
        closePopups();
    }

    function restoreData() { try { var d=JSON.parse(document.getElementById("restore-area").value); if(d&&d.length!==undefined) { eventsData=d; saveData(); closePopups(); alert("OK"); } } catch(e){ alert("Error"); } }
    function pad(n) { return n<10?'0'+n:n; } function formatDateStr(d) { return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate()); }
</script>
</body>
</html>